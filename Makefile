ROOT = ./.setup
COMPOSE_FILE = $(ROOT)/docker-compose.yml
DOCKER_COMPOSE = docker-compose -f $(COMPOSE_FILE)

DEFAULT_GOAL := help
.PHONY: help
help:
	@printf "[Makefile] Usage\n\tmake \033[36m<target>\033[0m\n"
	@count=`awk '/^.*-->@.*@$$/ {count++} END {print count}' $(MAKEFILE_LIST)`; index=0; while [ $$index -lt $$count ] ; do \
  		index=`expr $$index + 1`; \
  		regex="/^.*-->@$$index.*@$$/"; awk "$$regex "'{ printf "\n%s\n", substr($$0, 9, length($$0) - 9) }' $(MAKEFILE_LIST); \
  		fs='BEGIN {FS = ":.*==>@'$$index'"}'; regex="/^[a-zA-Z0-9_-]+:.*?==>@$$index/"; awk "$$fs $$regex "'{ printf "\t\033[36m%-27s\033[0m %s\n", $$1, $$2 }' $(MAKEFILE_LIST); \
	done

##-->@1 [Docker] Automatized Management of Project@
.PHONY: init
init: ##==>@1 Start all docker containers.
	$(DOCKER_COMPOSE) build
	$(DOCKER_COMPOSE) up -d

.PHONY: exec
exec: init ##==>@1 Exec command on specific container. To use CONTAINER=<service> COMMAND=<command>
	clear
	$(DOCKER_COMPOSE) exec -T $(CONTAINER) $(COMMAND)


##-->@2 [Linux] System Automation@
.PHONY: clear
clear: ##==>@2 Clear project, removing unncessary files
	find . -name "*.o" -type f | xargs rm -f
	find . -name "*.o.bin" -type f | xargs rm -f
	clear


##-->@3 [ASM] Build and Debug of Project@
.PHONY: compile
compile: ##==>@3 Compile ASM file to OBJECT file. To use ASM_FILE=<file.asm>
	make exec CONTAINER="target32" COMMAND="run nasm -f elf32 -o $(ASM_FILE).o $(ASM_FILE)"

.PHONY: link
link: ##==>@3 Link and generate binary file. To use ASM_FILE=<file.asm>
	make exec CONTAINER="target32" COMMAND="ld -o $(ASM_FILE).o.bin $(ASM_FILE).o"

.PHONY: dump
dump: ##==>@3 Show opcodes (shellcode) from binary file. To use ASM_FILE=<file.asm>
	make exec CONTAINER="target32" COMMAND="objdump -M intel -d $(ASM_FILE).o.bin"

.PHONY: test
test: ##==>@3 Show the last output interruption on stdout of system
	make exec CONTAINER="target32" COMMAND="./$(ASM_FILE).o.bin"
